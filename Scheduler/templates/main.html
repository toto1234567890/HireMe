<!DOCTYPE html>

    <html lang="en">
    <head>
    	<title>Hey !!</title>
    	<meta charset="UTF-8">
    	<meta name="viewport" content="width=device-width, initial-scale=1">
    	<link rel="shortcut icon" href="{{ url_for('static', path='/static/avatar.png') }}" />
    	<link rel="stylesheet" href="{{ url_for('static', path='/static/w3c/css/w3.css') }}">
        <link rel="stylesheet" href="{{ url_for('static', path='/static/w3c/css/prism.css') }}">
    	<link rel="stylesheet" href="{{ url_for('static', path='/static/fonts/font-awesome-4.7.0/css/font-awesome.min.css') }}">
    	<link rel="stylesheet" href="{{ url_for('static', path='/static/bootstrap/css/bootstrap.min.css') }}">
        <link rel="stylesheet" href="{{ url_for('static', path='/static/highlight/default.min.css')}}">

        <script src="{{ url_for('static', path='/static/js/prism.js') }}"></script>
    	<script src="{{ url_for('static', path='/static/js/jquery.min.js') }}"></script>
    	<script src="{{ url_for('static', path='/static/js/popper.min.js') }}"></script>
    	<script src="{{ url_for('static', path='/static/bootstrap/js/bootstrap.min.js') }}"></script>
    	<script src="{{ url_for('static', path='/static/highlight/highlight.min.js') }}"></script>
    </head>

    <body>
        <div class="container text-center">
            <h2>Scheduler Job Management                 
                <button type="button" class="btn btn-link" id="ShedulerLog" data-toggle="modal" data-target="#InfosSchedulerForm" onclick="infos_info_scheduler()"><i class="fa fa-list fa-fw"></i></button>
            </h2>
            <br>
            <div>
                <button type="button" id="ToggleRefresh" onclick="toggleAutoRefresh()"><i class="fa fa-recycle fa-fw"></i> Auto Refresh On</button>
            </div>

<!--------------------------------------------------------------------------------------------------------------------------------------------------------------------->
            <!-- Create Job Form -->
            <br>
            <br>
            <form>
                <button type="button" class="btn btn-success" id="CreateJobBtn" data-toggle="modal" data-target="#CreateJobForm" onclick="toggleCreateModify('create')"><i class="fa fa-plus-circle fa-fw"></i></button>
                <button type="button" class="btn btn-warning" id="RestoreJobBtn" data-toggle="modal" data-target="#InfosErroredForm" onclick="infos_errored_jobs()" style="display: none;"><i class="fa fa-exclamation-triangle fa-fw"></i></button>
            </form>
        
            <hr>

<!--------------------------------------------------------------------------------------------------------------------------------------------------------------------->
            <!-- Modal create job -->
            <div class="modal fade" id="CreateJobForm" role="dialog">
                <div class="modal-dialog modal-sm modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header bg-light">
                            <h4 class="modal-title">Job parameters</h4>
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="createJob">

                                <div class="form-group" hidden>
                                    <label for="id">Id:</label>
                                    <input type="text" class="form-control" id="id" name="id">
                                </div>

                                <div class="form-group">
                                    <label for="name">Job Name:</label>
                                    <input type="text" class="form-control" id="name" name="name" required>
                                </div>
                                <div class="form-group">
                                    <label for="func">Function:</label>
                                    <input type="text" class="form-control" id="func" name="func" required>
                                    <button id="search-button-create" type="button" class="btn btn-success"><i class="fa fa-search fa-fw"></i></button>
                                    <button id="search-button-modif" type="button" class="btn btn-primary"><i class="fa fa-search fa-fw"></i></button>
                                    <button id="search-button-restore" type="button" class="btn btn-warning"><i class="fa fa-search fa-fw"></i></button>
                                    <input type="file" id="fileInput" onclick="selectFile()" style="display: none;" accept=".py">
                                </div>
                                <div id="accordion">
                                    <div class="form-group" id="argsFields">
                                        <label for="args">Args:
                                            <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">  ** </button>
                                        </label> 
                                        <input type="text" class="form-control" id="args" name="args" placeholder="('arg1','arg2')">
                                    </div>
                                    <div class="form-group" id="kwargsFields">
                                        <label for="kwargs">Kwargs:
                                            <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">  ** </button>
                                        </label> 
                                        <input type="text" class="form-control" id="kwargs" name="kwargs" placeholder="{'param1':'value1','param2':'value2'}">
                                    </div>
                                    <div id="collapseOne" class="collapse hide" aria-labelledby="headingOne" data-parent="#accordion">
                                        <div id="helpAddKwargsButton" class="card-body">
                                            
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="jobType">Job Type:</label>
                                    <select class="form-control" id="jobType" name="trigger">
                                        <option value="cron">cron</option>
                                        <option value="date">date</option>
                                        <option value="interval">interval</option>
                                    </select>
                                </div>
                                <div class="form-group" id="cronFields">
                                    <label for="cron">Cron Expression: <button class="btn btn-link" id="CronJobBtn"><i class="fa fa-crosshairs fa-fw"></i></button></label>
                                    <input type="text" class="form-control" id="cron" name="cron" placeholder="e.g., 0 0 * * *">
                                </div>
                                <div class="form-group" id="intervalFields">
                                    <label for="interval">Interval (seconds): <button class="btn btn-link" id="IntervalJobBtn"><i class="fa fa-crosshairs fa-fw"></i></button></label>
                                    <input type="text" class="form-control" id="interval" name="interval">
                                </div>
                                <div class="form-group" id="dateFields">
                                    <label for="date">Date:</label>
                                    <input type="text" class="form-control" id="date" name="date" placeholder="YYYY-MM-DD HH:MM:SS">
                                </div>
                                <div class="form-group" id="max_instanceFields">
                                    <label for="max_instances">Max Instances:</label>
                                    <input type="text" class="form-control" id="max_instances" name="max_instances">
                                </div>
                                <div class="form-group" id="misfire_grace_timeFields">
                                    <label for="misfire_grace_time">Misfire grace time:</label>
                                    <input type="text" class="form-control" id="misfire_grace_time" name="misfire_grace_time">
                                </div>
                                <div class="form-group" id="descritionFields">
                                    <label for="description">Description:</label>
                                    <input type="text" class="form-control" id="description" name="description" placeholder="bla-bla-bla...">
                                </div>

                                <div class="form-group" id="executorFields">
                                    <label for="executor">Execution mode:</label>
                                    <select class="form-control" id="executor" name="executor">
                                        <option value="ProcessPool">ProcessPool</option>
                                        <option value="ThreadPool">ThreadPool</option>
                                    </select>
                                </div>

                                <div class="form-group" hidden>
                                    <label for="next_run_time">Next run time:</label>
                                    <input type="text" class="form-control" id="next_run_time" name="next_run_time">
                                </div>

                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="check" name="check">
                                    <label class="form-check-label" for="check">
                                        Disable
                                    </label>
                                </div>  
                                
                                <br><br>

                                <button id="createJobSubmit" type="submit" class="btn btn-success">Create Job</button>
                                <button id="modifyJobSubmit" type="submit" class="btn btn-primary">Modify Job</button>
                                <button id="restoreJobSubmit" type="submit" class="btn btn-warning">Restore Job</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        
<!--------------------------------------------------------------------------------------------------------------------------------------------------------------------->
            <!-- Modal add cron job params -->
            <div class="modal fade" id="CronJobForm" role="dialog">
                <div class="modal-dialog modal-sm modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header bg-light">
                            <h4 class="modal-title">Job cron parameters</h4>
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                        </div>

                        <div class="modal-body">
                            <form id="createCronJob">
                                <div class="form-group">
                                    <label for="cron_year">Year:</label>
                                    <input type="text" class="form-control" id="cron_year" name="cron_year">
                                </div>
                                <div class="form-group">
                                    <label for="cron_month">Month:</label>
                                    <input type="text" class="form-control" id="cron_month" name="cron_month">
                                </div>
                                <div class="form-group">
                                    <label for="cron_day">Day:</label>
                                    <input type="text" class="form-control" id="cron_day" name="cron_day">
                                </div>
                                <div class="form-group">
                                    <label for="cron_week">Week:</label>
                                    <input type="text" class="form-control" id="cron_week" name="cron_week">
                                </div>
                                <div class="form-group">
                                    <label for="cron_day_of_week">Day_of_week:(monday=0)</label>
                                    <input type="text" class="form-control" id="cron_day_of_week" name="cron_day_of_week">
                                </div>
                                <div class="form-group">
                                    <label for="cron_hour">Hour:</label>
                                    <input type="text" class="form-control" id="cron_hour" name="cron_hour">
                                </div>
                                <div class="form-group">
                                    <label for="cron_minute">Minute:</label>
                                    <input type="text" class="form-control" id="cron_minute" name="cron_minute">
                                </div>
                                <div class="form-group">
                                    <label for="cron_second">Second:</label>
                                    <input type="text" class="form-control" id="cron_second" name="cron_second">
                                </div>
                                <div class="form-group">
                                    <label for="cron_start_date">Start_date:</label>
                                    <input type="text" class="form-control" id="cron_start_date" name="cron_start_date">
                                </div>
                                <div class="form-group">
                                    <label for="cron_end_date">End_date:</label>
                                    <input type="text" class="form-control" id="cron_end_date" name="cron_end_date">
                                </div>
                                <div class="form-group">
                                    <label for="cron_timezone">Timezone:</label>
                                    <input type="text" class="form-control" id="cron_timezone" name="cron_timezone">
                                </div>
                                <div class="form-group">
                                    <label for="cron_jitter">Jitter:</label>
                                    <input type="text" class="form-control" id="cron_jitter" name="cron_jitter">
                                </div>
                                <div class="modal-footer">
                                    <button id=createCron type="submit" class="btn btn-success">Add Cron Params</button>
                                    <button id=modifCron type="submit" class="btn btn-primary">Modify Cron Params</button>
                                    <button id=restoreCron type="submit" class="btn btn-warning">Restore Cron Params</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>  

<!--------------------------------------------------------------------------------------------------------------------------------------------------------------------->
            <!-- Modal add interval job params -->
            <div class="modal fade" id="IntervalJobForm" role="dialog">
                <div class="modal-dialog modal-sm modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header bg-light">
                            <h4 class="modal-title">Job interval parameters</h4>
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                        </div>
                        <!--class IntervalTrigger(
                            weeks: int = 0,
                            days: int = 0,
                            hours: int = 0,
                            minutes: int = 0,
                            seconds: int = 0,
                            start_date: Any | None = None,
                            end_date: Any | None = None,
                            timezone: Any | None = None,
                            jitter: Any | None = None)-->
                        <div class="modal-body">
                            <form id="createIntervalJob">
                                <div class="form-group">
                                    <label for="int_weeks">Weeks:</label>
                                    <input type="number" class="form-control" id="int_weeks" name="int_weeks">
                                </div>
                                <div class="form-group">
                                    <label for="int_days">Days:</label>
                                    <input type="number" class="form-control" id="int_days" name="int_days">
                                </div>
                                <div class="form-group">
                                    <label for="int_hours">Hours:</label>
                                    <input type="number" class="form-control" id="int_hours" name="int_hours">
                                </div>
                                <div class="form-group">
                                    <label for="int_minutes">Minutes:</label>
                                    <input type="number" class="form-control" id="int_minutes" name="int_minutes">
                                </div>
                                <div class="form-group">
                                    <label for="int_seconds">Seconds:</label>
                                    <input type="number" class="form-control" id="int_seconds" name="int_seconds">
                                </div>
                                <div class="form-group">
                                    <label for="int_start_date">Start_date:</label>
                                    <input type="text" class="form-control" id="int_start_date" name="int_start_date">
                                </div>
                                <div class="form-group">
                                    <label for="int_end_date">End_date:</label>
                                    <input type="text" class="form-control" id="int_end_date" name="int_end_date">
                                </div>
                                <div class="form-group">
                                    <label for="int_timezone">Timezone:</label>
                                    <input type="text" class="form-control" id="int_timezone" name="int_timezone">
                                </div>
                                <div class="form-group">
                                    <label for="int_jitter">Jitter:</label>
                                    <input type="int" class="form-control" id="int_jitter" name="int_jitter">
                                </div>
                                <div class="modal-footer">
                                    <button id=createInt type="submit" class="btn btn-success">Add Interval Params</button>
                                    <button id=modifInt type="submit" class="btn btn-primary">Modify Interval Params</button>
                                    <button id=restoreInt type="submit" class="btn btn-warning">Restore Interval Params</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>                        

<!--------------------------------------------------------------------------------------------------------------------------------------------------------------------->
            <!-- Modal check file content  -->
            <div class="modal" role="dialog" id="fileModal">
                <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
                    <div class="modal-content">
                        <div class="modal-header bg-light">
                            <h5 class="modal-title">Module file</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <pre><code class="language-python" id="fileData"></code></pre>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary mr-auto" onclick="SelectOther()" >Select other</button>
                            <button type="button" class="btn btn-success" data-dismiss="modal" onclick="validateFile()" >Select file</button>
                        </div>
                    </div>
                </div>
            </div>           

<!--------------------------------------------------------------------------------------------------------------------------------------------------------------------->
            <!-- Modal get infos -->
            <div class="modal fade" id="InfosJobForm" role="dialog">
                <div class="modal-dialog modal-lg modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header bg-light">
                            <h4 class="modal-title">Job Info :</h4>
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                        </div>
                        <div class="modal-body">
                            <h4 id="InfosJobName" name="InfosJobName"></h4>
                            <div class="card-body"  id="InfosJobDescription" name="InfosJobDescription"></div>
                            <div class="card-body"  id="InfosJobTrigger" name="InfosJobTrigger"></div>
                            <div class="card-body">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th scope="col">Id</th>
                                            <th scope="col">Function</th>
                                            <th scope="col">Args</th>
                                            <th scope="col">Kwargs</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td id="InfosJobid" name="InfosJobid"></td>
                                            <td id="InfosJobFunc_ref" name="InfosJobFunc_ref"></td>
                                            <td id="InfosJobArgs" name="InfosJobArgs"></td>
                                            <td id="InfosJobKwargs" name="InfosJobKwargs"></td>  
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <hr>
                            <br>
                            <br>
                            <h4 id="InfosJobRun" name="InfosJobRun" style="text-align: left;">Last runs :</h4>
                            <table class="table" id="Tablelastruns">
                                <thead>
                                    <tr>
                                        <th scope="col"></th>
                                        <th scope="col">Date</th>
                                        <th scope="col">Func Name</th>
                                        <th scope="col">Execution</th>
                                        <th scope="col">Log</th>
                                    </tr>
                                </thead>
                                <tbody id="lastruns">

                                </tbody> 
                            </table>
                            <hr>
                            <br>
                            <br>
                            <h4 style="text-align: left;">Task :</h4>
                            <hr>
                            <div class="modal-body">
                                <pre><code class="language-python" id="InfosJobScriptStr" name="InfosJobScriptStr"></code></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>           
            
<!--------------------------------------------------------------------------------------------------------------------------------------------------------------------->
            <!-- Modal get scheduler infos -->
            <div class="modal fade" id="InfosSchedulerForm" role="dialog">
                <div class="modal-dialog modal-lg modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header bg-light">
                            <h4 class="modal-title">Scheduler Info :</h4>
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                        </div>
                        <div class="modal-body">
                            <h4 id="InfosSchedulerRun" name="InfosSchedulerRun" style="text-align: left;"></h4>
                            <table class="table" id="TableScheduler">
                                <thead>
                                    <tr>
                                        <th scope="col"></th>
                                        <th scope="col">Date</th>
                                        <th scope="col">Job Name</th>
                                        <th scope="col">Func Name</th>
                                        <th scope="col">Execution</th>
                                        <th scope="col">Log</th>
                                    </tr>
                                </thead>
                                <tbody id="SchedulerInfos">

                                </tbody> 
                            </table>
                        </div>
                    </div>
                </div>
            </div>       

<!--------------------------------------------------------------------------------------------------------------------------------------------------------------------->
            <!-- List of Jobs -->
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th scope="col">Execute</th>
                            <th scope="col">Infos</th>
                            <th scope="col" hidden>Job ID</th>
                            <th scope="col">Job Name</th>
                            <th scope="col">Next Run Time</th>
                            <th scope="col">Job Pending</th>
                            <th scope="col">Play/Pause</th>
                            <th scope="col">Edit</th>
                            <th scope="col">Remove</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for job in jobs %}
                            <tr>
                                <td>
                                    <button class="btn btn-info" onclick="exec_job('{{ job.id }}')"><i class="fa fa-bolt fa-fw"></i></button>
                                </td>
                                <td>
                                    <button class="btn btn-secondary" onclick="infos_job('{{ job.id }}')"><i class="fa fa-info fa-fw"></i></button>
                                </td>
                                <td hidden>
                                    {{ job.id }}
                                </td>
                                <td>
                                    {{ job.name }}
                                </td>
                                <td>
                                    <span class="badge badge-{% if job.next_run_time==None %}danger{% elif not job.pending %}success{% else %}warning{% endif %}">{{ job.next_run_time }}</span>
                                </td>
                                <td>
                                    <span class="badge badge-{% if job.next_run_time==None %}danger{% elif not job.pending %}success{% else %}warning{% endif %}">{{ job.pending }}</span>  
                                </td>
                                <td>                           
                                    <button class="toggle-btn btn btn-dark" onclick="togglePlayStop('{{ job.id }}', '{{ job.next_run_time }}')">
                                        {% if job.next_run_time==None %} 
                                        <i id="playIcon{{ job.id }}" class="fa fa-play fa-fw"></i>
                                        {% else %}
                                        <i id="stopIcon{{ job.id }}" class="fa fa-stop fa-fw"></i>
                                        {% endif %}
                                    </button>
                                </td>
                                <td> 
                                    <button class="btn btn-primary" onclick="get_job('{{ job.id }}')"><i class="fa fa-pencil fa-fw"></i></button>
                                </td>
                                <td> 
                                    <button class="btn btn-danger" onclick="remove_job('{{ job.id }}')"><i class="fa fa-remove fa-fw"></i></button>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

<!--------------------------------------------------------------------------------------------------------------------------------------------------------------------->
            <!-- Execution log -->
            <div class="modal fade" id="logModal" role="dialog">
                <div class="modal-dialog modal-dialog-centered modal-sm modal-dialog-scrollable">
                    <div class="modal-content" style="border: 3px solid #000000; ">
                        <div class="modal-header bg-light">
                            <h4 class="modal-title">Execution log :</h4>
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                        </div>
                        <div class="modal-body">
                            <p id="modalContent"></p>
                        </div>
                    </div>
                </div>
            </div>

<!--------------------------------------------------------------------------------------------------------------------------------------------------------------------->
            <!-- Modal errored jobs infos -->
            <div class="modal fade" id="InfosErroredForm" role="dialog">
                <div class="modal-dialog modal-lg modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header bg-light">
                            <h4 class="modal-title">Errored Job :</h4>
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                        </div>
                        <div class="modal-body">
                            <h4 id="InfosErrored" name="InfosErrored" style="text-align: left;"></h4>
                            <table class="table" id="TableScheduler">
                                <thead>
                                    <tr>
                                        <th scope="col"></th>
                                        <th scope="col">Job ID</th>
                                        <th scope="col">Job Name</th>
                                        <th scope="col">Job Description</th>
                                        <th scope="col"></th>
                                    </tr>
                                </thead>
                                <tbody id="InfosErroredjobs">

                                </tbody> 
                            </table>
                        </div>
                    </div>
                </div>
            </div>   

<!--------------------------------------------------------------------------------------------------------------------------------------------------------------------->
    <!-- JavaScript for Form Submission and AJAX Requests -->
    <script>
        var ModifOrCreate = "None";
        var script = '';

        if (localStorage.getItem('AutoRefreshScheduler')===null) {localStorage.setItem('AutoRefreshScheduler', 'true');}
        toggleAutoRefresh(change=false);

        function isJSONString(value) {
            const jsonValueRegex = /^\{.*\}$/;;
            return jsonValueRegex.test(value);
        }
        function toggleCreateModify(type) {
            ModifOrCreate = type;
            if (type==="modify")
            {
                $("#modifyJobSubmit").show();
                $("#createJobSubmit").hide();
                $("#restoreJobSubmit").hide();
                $("#search-button-modif").show();
                $("#search-button-create").hide();
                $("#search-button-restore").hide();
                $("#modifCron").show();
                $("#createCron").hide();
                $("#restoreCron").hide();
                $("#modifInt").show();
                $("#createInt").hide();
                $("#restoreInt").hide();
            }
            else if (type==="restore")
            {
                $("#restoreJobSubmit").show();
                $("#modifyJobSubmit").hide();
                $("#createJobSubmit").hide();
                $("#search-button-restore").show();
                $("#search-button-modif").hide();
                $("#search-button-create").hide();
                $("#restoreCron").show();
                $("#modifCron").hide();
                $("#createCron").hide();
                $("#restoreInt").show();
                $("#createInt").hide();
                $("#modifInt").hide();
            }
            else
            {
                $("#createJobSubmit").show();
                $("#modifyJobSubmit").hide();
                $("#restoreJobSubmit").hide();
                $("#search-button-create").show();
                $("#search-button-modif").hide();
                $("#search-button-restore").hide();
                $("#createCron").show();
                $("#modifCron").hide();
                $("#restoreCron").hide();
                $("#createInt").show();
                $("#modifInt").hide();
                $("#restoreInt").hide();
            }
        }
        // convert form data to dictionnary
        function formDataToDict(formData) {
            //(method) def add_job(
            //            func: Any,
            //            trigger: Any | None = None,
            //            args: Any | None = None,
            //            kwargs: Any | None = None,
            //            id: Any | None = None,
            //            name: Any | None = None,
            //            misfire_grace_time: _Undefined | Any = undefined,
            //            coalesce: _Undefined | Any = undefined,
            //            max_instances: _Undefined | Any = undefined,
            //            next_run_time: _Undefined | Any = undefined,
            //            jobstore: str = 'default',
            //            executor: str = 'default',
            //            replace_existing: bool = False,
            //            **trigger_args: Any)
            const dict = {};
            const params = new URLSearchParams(formData);
            for (let [key, value] of params) {
                if (value.length > 0) {
                    if (key === "cron" || key === "date" || key === "interval"){
                        if (key === "interval") {
                            dict["trigger"] = key;
                            if (isJSONString(value)) {dict["interval"] = value;}
                            else {dict["seconds"] = +value;}
                        }
                        else if (key === "cron") {dict["trigger"] = key ; dict["cron"] = value; }
                        else {dict["trigger"] = key ; dict["date"] = value; }
                    }else{
                        if (key.startsWith("cron_")) {key=key.substring("cron_".length);}
                        if (key.startsWith("int_")) {
                            key=key.substring("int_".length);
                            if (key==="start_date" || key==="end_date"){value=value;}
                            else {value=+value;}
                        }
                        if (key === "max_instance") {value=+value;}
                        if (key === "func") {value=value.split(':').map(part => part.trim()).join(':') ;}
                        dict[key] = value;
                    }
                };
                if (key==="next_run_time") {
                    // pause job
                    if ($("#check").prop("checked")===true) {dict[key]='None';}
                    // put the original next run time
                    else if (value!=='') {dict[key]=formatDateUTC(new Date(value))}
                    // ASAP, let the scheduler calculate the new date
                    else {dict[key]='ASAP'}
                }
                if (key === "misfire_grace_time") {
                    if (value == '') {dict[key] = 1;}
                    else {dict[key] = +value;}
                }
            }
            delete dict["check"]
            return dict;
        }
        function formatDate(date) {
            const year = String(date.getFullYear());
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }
        function formatDateUTC(date) {
            const year = String(date.getUTCFullYear());
            const month = String(date.getUTCMonth() + 1).padStart(2, '0');
            const day = String(date.getUTCDate()).padStart(2, '0');
            const hours = String(date.getUTCHours()).padStart(2, '0');
            const minutes = String(date.getUTCMinutes()).padStart(2, '0');
            const seconds = String(date.getUTCSeconds()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }
        $(document).ready(function () {
            // hide job type by default on modal create job...
            $("#intervalFields").hide();
            $("#dateFields").hide();
            $("#cronFields").prop("required", true);

            if (!sessionStorage.getItem('get_help_add_kwargs')) {
                // Perform AJAX request to get docstring help
                $.ajax({
                    type: "GET",
                    url: "/get_help_add_kwargs",
                    success: function (response) {
                        var accordion = $("#helpAddKwargsButton");
                        accordion.append(response);
                        sessionStorage.setItem('get_help_add_kwargs', response);
                    },
                    error: function (error) {
                        alert('Error while trying to get kwargs docstring:', error.responseJSON.detail);
                    }
                });
            }
            else{
                var accordion = $("#helpAddKwargsButton");  
                accordion.append(sessionStorage.getItem('get_help_add_kwargs'));
            }

            $.ajax({
                    type: "GET",
                    url: "/get_errored_jobs",
                    success: function (response) {
                        if (Object.keys(JSON.parse(response)).length>0) {$('#RestoreJobBtn').show()} else {$('#RestoreJobBtn').hide()}
                    },
                    error: function (error) {
                        alert('Error while trying to get errored job list:', error.responseJSON.detail);
                    }
                });

            $('#CreateJobForm').on('keydown', function(event) {
                if (event.which === 13) {
                    event.preventDefault();
                }
            });

            // Trigger reload for auto-reload on close form
            $("#CreateJobForm.modal").on('hidden.bs.modal', function () {
                location.reload();
            });

            // Show/hide fields based on selected job type
            $("#jobType").change(function () {
                if ($(this).val() === "interval") {
                    $("#intervalFields").show();
                    $("#intervalFields").prop("required", true);
                    $("#cronFields").hide();
                    $("#dateFields").hide();
                } else if ($(this).val() === "cron") {
                    $("#intervalFields").hide();
                    $("#cronFields").show();
                    $("#cronFields").prop("required", true);
                    $("#dateFields").hide();
                } else if ($(this).val() === "date") {
                    $("#intervalFields").hide();
                    $("#cronFields").hide();
                    $("#dateFields").show();
                    $("#dateFields").prop("required", true);
                } else {
                    // Hide all fields for other job types
                    $("#intervalFields").hide();
                    $("#cronFields").show();
                    $("#cronFields").prop("required", true);
                    $("#dateFields").hide();
                }
            });

////////////////////////////////////////////////////////////////////////////////////////////////////////////        
            // create job from form
            $("#createJob").submit(function(event) {
                event.preventDefault();
                var formData = formDataToDict($(this).serialize());
                formData["script"] = script.trim(); 
                // to be compatible with CORS and monitoring server...
                if (ModifOrCreate==="modify")
                    {$.ajax({
                        type: "POST",
                        url: "/modify_job",
                        contentType: 'application/json',
                        data: JSON.stringify(formData), 
                        success: function (response) {
                            location.reload();
                            script = "";
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            if (jqXHR.responseJSON && jqXHR.responseJSON.detail) {
                                alert("Error: " + jqXHR.responseJSON.detail);
                            } else {
                                alert("Error: " + errorThrown);
                            }
                        }
                    });
                }
                else
                {$.ajax({
                    type: "POST",
                    url: "/create_job",
                    contentType: 'application/json',
                    data: JSON.stringify(formData), 
                    success: function (response) {
                        if (ModifOrCreate==="restore")
                        {
                            $.ajax({
                                type: "POST",
                                url: `/restored_job/${formData.id}`,
                                contentType: 'application/json',
                                success: function (response) {
                                    location.reload();
                                    script = "";     
                                },
                                error: function (jqXHR, textStatus, errorThrown) {
                                    if (jqXHR.responseJSON && jqXHR.responseJSON.detail) {
                                        alert("Error: " + jqXHR.responseJSON.detail);
                                    } else {
                                        alert("Error: " + errorThrown);
                                    }
                                }
                            }
                        )}
                        else {
                            location.reload();
                            script = "";
                        }
                        
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                            if (jqXHR.responseJSON && jqXHR.responseJSON.detail) {
                                alert("Error: " + jqXHR.responseJSON.detail);
                            } else {
                                alert("Error: " + errorThrown);
                            }
                        }
                    });
                }
            });


            $('#CronJobBtn').on('click',function(event) {
                event.preventDefault(); 
                $('#CronJobForm').modal('show');
                if ($('#cron_start_date').val() === '') {
                    $('#cron_start_date').val(formatDate(new Date()));
                }
            });

            $('#IntervalJobBtn').on('click',function(event) {
                event.preventDefault(); 
                $('#IntervalJobForm').modal('show');
                if ($('#int_start_date').val() === '') {
                    $('#int_start_date').val(formatDate(new Date()));
                }
            });

            $("#createCronJob").submit(function(event) {
                event.preventDefault();
                var formData = formDataToDict($(this).serialize());
                $('#cron').val(JSON.stringify(formData));
                $("#CronJobForm").modal('hide');
            });

            $("#createIntervalJob").submit(function(event) {
                event.preventDefault();
                var formData = formDataToDict($(this).serialize());
                $('#interval').val(JSON.stringify(formData));
                $("#IntervalJobForm").modal('hide');
            });

            // Add an event listener to the label to trigger the file input
            document.getElementById('search-button-create').addEventListener('click', function () {
                document.getElementById('fileInput').click();
            });
            document.getElementById('search-button-modif').addEventListener('click', function () {
                document.getElementById('fileInput').click();
            });

        });

////////////////////////////////////////////////////////////////////////////////////////////////////////////  
        // Function to trigger file input
        function selectFile() {
            document.getElementById('fileInput').click();
        }
        function SelectOther() {
            document.getElementById('search-button-create').click();
        }
        document.getElementById('fileInput').addEventListener('change', function (event) {
            const fileInput = event.target;
            const file = fileInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('func').value = file.name.replace(/\.py$/, ":");
                    document.getElementById('fileData').textContent = e.target.result;
                    $('#fileModal').modal('show');
                    Prism.highlightAll();
                    
                };
                reader.readAsText(file);
            }
        });

////////////////////////////////////////////////////////////////////////////////////////////////////////////       
        // Function to record module file
        function validateFile() {
            document.getElementById('fileInput').value='';
            const fileContent = document.getElementById('fileData').textContent;
            script = fileContent
        }

////////////////////////////////////////////////////////////////////////////////////////////////////////////       
        // Function to toggle play/stop
        function togglePlayStop(jobId, jobNext_run_time) {
            if (jobNext_run_time === 'None') {
                playFunction(jobId);
            } else {
                stopFunction(jobId);
            }
        }
        function playFunction(jobId) {
            $.ajax({
                type: "POST",
                url: `/resume_job/${jobId}`,
                contentType: 'application/json',
                success: function(response) {
                    location.reload();
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    if (jqXHR.responseJSON && jqXHR.responseJSON.detail) {
                        alert("Error: " + jqXHR.responseJSON.detail);
                    } else {
                        alert("Error: " + errorThrown);
                    }
                }
            });
        }
        function stopFunction(jobId) {
            $.ajax({
                type: "POST",
                url: `/pause_job/${jobId}`,
                contentType: 'application/json',
                success: function(response) {
                    location.reload();
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    if (jqXHR.responseJSON && jqXHR.responseJSON.detail) {
                        alert("Error: " + jqXHR.responseJSON.detail);
                    } else {
                        alert("Error: " + errorThrown);
                    }
                }
            });
        }

////////////////////////////////////////////////////////////////////////////////////////////////////////////        
        // Delete job 
        function remove_job(jobId) {
            if (confirm("Are you sure you want to delete this job ?")) {
                $.ajax({
                    type: "DELETE",
                    url: `/remove_job/${jobId}`,
                    contentType: 'application/json',
                    success: function(response) {
                        location.reload();
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        if (jqXHR.responseJSON && jqXHR.responseJSON.detail) {
                            alert("Error: " + jqXHR.responseJSON.detail);
                        } else {
                            alert("Error: " + errorThrown);
                        }
                    }
                });
            }
        }

////////////////////////////////////////////////////////////////////////////////////////////////////////////        
        // Get job 
        function RestoreOrModify(resp, mode) {
            var type = 'date';
            var triggerType = resp["type"]
            for (var [key, value] of Object.entries(resp)) {
                if (key==="cron" || key==="interval" || key==="date"){
                    type=key;
                    value = value.replace(/[0-9]{4}-(0[1-9]|1[0-2])-(0[1-9]|[1-2][0-9]|3[0-1]) (2[0-3]|[01][0-9]):[0-5][0-9]:[0-5][0-9] [A-Z]{3}/g, function(match) {return match.slice(0, -4);});
                    if (key==="interval"){
                        value = value.replace(/"days": "\d+"/, function(match){return '"days": '+parseInt(match.slice(9, -1));});
                        value = value.replace(/"seconds": "\d+"/, function(match){return '"seconds": '+parseInt(match.slice(12, -1));});
                    }
                }
                else if (key === "params") {
                    for (var [key2, value2] of Object.entries(value)) {
                        if (key2==="start_date") {
                            value2=value2.substring(0, value2.length-4);
                            value["start_date"]=value2;
                        }
                        if (key2==="end_date") {
                            value2=value2.substring(0, value2.length-4); 
                            value["end_date"]=value2;
                        }
                        if (triggerType==="CronTrigger") {$("#cron_"+key2).val(value2);}
                        else if (triggerType==="IntervalTrigger") {$("#int_"+key2).val(value2);}
                        else {
                            value2=value2.substring(0, value2.length-4);
                            $("#date").val(value2);
                        }
                    }
                }
                if (key === "next_run_time") {if (value===null){$("#check").prop("checked", true);} else $("#check").prop("checked", false);} 
                if (key === "args") {value=`(${JSON.parse(value).map(element => typeof element === 'number' ? element : `"${element}"`).join(', ')}, )`;}
                if (key === "script") {$("#fileData").val(value);script = value;}
                $("#"+key).val(value);
            }
            $("#jobType").val(type).change();
            $("#executor").val(resp["executor"]).change();
            toggleCreateModify(mode);
            if (mode==="restore") {$('#InfosErroredForm').hide();}
            $("#CreateJobForm").modal('show');
        }
        function get_job(jobId) {
            $.ajax({
                type: "GET",
                url: `/get_job/${jobId}`,
                contentType: 'application/json',
                success: function(response) {
                    RestoreOrModify(JSON.parse(response), mode="modify");
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    if (jqXHR.responseJSON && jqXHR.responseJSON.detail) {
                        alert("Error: " + jqXHR.responseJSON.detail);
                    } else {
                        alert("Error: " + errorThrown);
                    }
                }
            });
        }

////////////////////////////////////////////////////////////////////////////////////////////////////////////        
        // Infos job 
        function openLogModal(content) {
            document.getElementById("modalContent").textContent = content;
            $('#logModal').modal('show');
        }
        function formatInfos(data) {
            document.getElementById('InfosJobName').textContent = data.name; 
            document.getElementById('InfosJobDescription').textContent = data.description;
            document.getElementById('InfosJobTrigger').textContent = data.trigger; 
            document.getElementById('InfosJobid').textContent = data.id; 
            document.getElementById('InfosJobFunc_ref').textContent = (data.func_ref.split(':')[1]) || "__main__"; 
            document.getElementById('InfosJobArgs').textContent = data.args; 
            document.getElementById('InfosJobKwargs').textContent = data.kwargs;
            document.getElementById('InfosJobScriptStr').textContent = data.scriptStr;

            let tableBody = document.getElementById("lastruns");
            tableBody.innerHTML='';
            let rowNumber = 1
            data.lastruns.forEach(function(value) {
               let row = tableBody.insertRow();
               if (typeof value === 'object' && value !== null) {
                    let [jobScriptNameFunc, schedParam] = value.func_name.split('|')
                    let [jobName, scriptName, funcNparam] = jobScriptNameFunc.split(':')
                    var buttonLog = document.createElement("button");
                            buttonLog.className = "btn btn-light";
                            buttonLog.innerHTML = `<i class="fa fa-info fa-fw"></i>`;
                            buttonLog.onclick = function() {openLogModal(value.log_message);};
                    let i = 0
                    row.insertCell(i++).textContent = rowNumber++;
                    row.insertCell(i++).textContent = formatDateUTC(new Date(value.log_date));
                    row.insertCell(i++).textContent = scriptName+" - "+funcNparam+" - "+schedParam;
                    row.insertCell(i++).innerHTML = (value.line === "EVENT_JOB_EXECUTED") 
                                                        ? '<button class="btn btn-success"><i class="fa fa-check fa-fw"></i></button>' 
                                                        :(value.line === "EVENT_JOB_MODIFIED") 
                                                        ? '<button class="btn btn-primary"><i class="fa fa-pencil fa-fw"></i></button>'
                                                        :(value.line === "EVENT_JOB_PAUSED") 
                                                        ? '<button class="btn btn-dark"><i class="fa fa-stop fa-fw"></i></button>'
                                                        :(value.line === "EVENT_JOB_RESUMED") 
                                                        ? '<button class="btn btn-dark"><i class="fa fa-play fa-fw"></i></button>'
                                                        :(value.line === "EVENT_JOB_MISSED") 
                                                        ? '<button class="btn btn-warning"><i class="fa fa-clock-o fa-fw"></i></button>'
                                                        :(value.line === "EVENT_JOB_ERROR") 
                                                        ? '<button class="btn btn-danger"><i class="fa fa-remove fa-fw"></i></button>'
                                                        : '<button class="btn btn-danger"><i class="fa fa-question-circle fa-fw"></i></button>';
                    row.insertCell(i++).appendChild(buttonLog);
                }});
            Prism.highlightAll();
        }
        function exec_job(jobId) {
            $.ajax({
                type: "POST",
                url: `/exec_job/${jobId}`,
                contentType: 'application/json',
                success: function(response) {
                    location.reload();
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    if (jqXHR.responseJSON && jqXHR.responseJSON.detail) {
                        alert("Error: " + jqXHR.responseJSON.detail);
                    } else {
                        alert("Error: " + errorThrown);
                    }
                }
            });
        }
        function infos_job(jobId) {
            $.ajax({
                type: "GET",
                url: `/infos_job/${jobId}`,
                contentType: 'application/json',
                success: function(response) {
                    formatInfos(response);
                    $('#InfosJobForm').modal('show');
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    if (jqXHR.responseJSON && jqXHR.responseJSON.detail) {
                        alert("Error: " + jqXHR.responseJSON.detail);
                    } else {
                        alert("Error: " + errorThrown);
                    }
                }
            });
        }
        function formatschedulerInfos(data) {
            let tableBody = document.getElementById("SchedulerInfos");
            tableBody.innerHTML='';
            let rowNumber = 1
            data.infosScheduler.forEach(function(value) {
               let row = tableBody.insertRow();
               if (typeof value === 'object' && value !== null) {
                    var buttonLog = document.createElement("button");
                            buttonLog.className = "btn btn-light";
                            buttonLog.innerHTML = `<i class="fa fa-info fa-fw"></i>`;
                            buttonLog.onclick = function() {openLogModal(value.log_message);};
                    let i = 0
                    let [jobScriptNameFunc, schedParam] = value.func_name.split('|')
                    let [jobName, scriptName, funcNparam] = jobScriptNameFunc.split(':')
                    row.insertCell(i++).textContent = rowNumber++;
                    row.insertCell(i++).textContent = formatDateUTC(new Date(value.log_date));
                    row.insertCell(i++).textContent = jobName;
                    row.insertCell(i++).textContent = scriptName+" - "+funcNparam+" - "+schedParam;
                    row.insertCell(i++).innerHTML = (value.line === "EVENT_JOB_ADDED") 
                                                        ? '<button class="btn btn-success"><i class="fa fa-plus-circle fa-fw"></i></button>' 
                                                        :(value.line === "EVENT_JOB_MODIFIED") 
                                                        ? '<button class="btn btn-primary"><i class="fa fa-pencil fa-fw"></i></button>'
                                                        :(value.line === "EVENT_JOB_PAUSED") 
                                                        ? '<button class="btn btn-dark"><i class="fa fa-stop fa-fw"></i></button>'
                                                        :(value.line === "EVENT_JOB_RESUMED") 
                                                        ? '<button class="btn btn-dark"><i class="fa fa-play fa-fw"></i></button>'
                                                        :(value.line === "EVENT_JOB_RESCHEDULED") 
                                                        ? '<button class="btn btn-info"><i class="fa fa-refresh fa-fw"></i></button>'
                                                        :(value.line === "EVENT_JOB_REMOVED") 
                                                        ? '<button class="btn btn-danger"><i class="fa fa-trash fa-fw"></i></button>'
                                                        :(value.line === "EVENT_SCHEDULER_STARTED") 
                                                        ? '<button class="btn btn-secondary"><i class="fa fa-hourglass-start fa-fw"></i></button>'
                                                        :(value.line === "EVENT_SCHEDULER_SHUTDOWN") 
                                                        ? '<button class="btn btn-secondary"><i class="fa fa-hourglass-end fa-fw"></i></button>'
                                                        :(value.line === "EVENT_SCHEDULER_PAUSED") 
                                                        ? '<button class="btn btn-secondary"><i class="fa fa-pause fa-fw"></i></button>'
                                                        :(value.line === "EVENT_SCHEDULER_RESUMED") 
                                                        ? '<button class="btn btn-secondary"><i class="fa fa-fast-forward fa-fw"></i></button>'
                                                        : '<button class="btn btn-danger"><i class="fa fa-question-circle fa-fw"></i></button>';
                    row.insertCell(i++).appendChild(buttonLog);
                }});
        }
        function infos_info_scheduler() {
            $.ajax({
                type: "GET",
                url: `/infos_scheduler`,
                contentType: 'application/json',
                success: function(response) {
                    formatschedulerInfos(response);
                    $('#InfosSchedulerForm').modal('show');
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    if (jqXHR.responseJSON && jqXHR.responseJSON.detail) {
                        alert("Error: " + jqXHR.responseJSON.detail);
                    } else {
                        alert("Error: " + errorThrown);
                    }
                }
            });
        }
        function formatErroredJobs(data) {
            let tableBody = document.getElementById("InfosErroredjobs");
            tableBody.innerHTML='';
            let rowNumber = 1
            for (const [key, value] of Object.entries(data)) {
               let row = tableBody.insertRow();
               jobObj = JSON.parse(value)
                var buttonErrored = document.createElement("button");
                    buttonErrored.className = "btn btn-warning";
                    buttonErrored.innerHTML = `<i class="fa fa-window-restore fa-fw"></i>`;
                    buttonErrored.onclick = function() {RestoreOrModify(jobObj, "restore");};
                let i = 0
                row.insertCell(i++).textContent = rowNumber++;
                row.insertCell(i++).textContent = key;
                row.insertCell(i++).textContent = jobObj.name;
                row.insertCell(i++).textContent = jobObj.description;
                row.insertCell(i++).appendChild(buttonErrored);
            };
        }
        function infos_errored_jobs() {
            $.ajax({
                type: "GET",
                url: `/get_errored_jobs`,
                contentType: 'application/json',
                success: function(response) {
                    formatErroredJobs(JSON.parse(response));
                    $('#InfosErroredForm').modal('show');
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    if (jqXHR.responseJSON && jqXHR.responseJSON.detail) { 
                        alert("Error: " + jqXHR.responseJSON.detail);
                    } else {
                        alert("Error: " + errorThrown);
                    }
                }
            });
        }

////////////////////////////////////////////////////////////////////////////////////////////////////////////        
        // Page auto-reload
        function reloadPage() {
            var isFormOpen = false;
            var modals = document.querySelectorAll('.modal');
            for (var i = 0; i < modals.length; i++) {
                if ($(modals[i]).hasClass('show')) {
                    isFormOpen = true;
                }
            }
            if (!isFormOpen) {
                if (localStorage.getItem('AutoRefreshScheduler')==='true') { 
                    location.reload();
                }
            }
        }

        function toggleAutoRefresh(change=true) {
            if (localStorage.getItem('AutoRefreshScheduler')==='true') { 
                if (change) {
                    localStorage.setItem('AutoRefreshScheduler', 'false'); 
                    document.getElementById('ToggleRefresh').innerHTML = '<i class="fa fa-recycle fa-fw"></i> Auto Refresh Off';
                }
                else {
                    document.getElementById('ToggleRefresh').innerHTML = '<i class="fa fa-recycle fa-fw"></i> Auto Refresh On';
                }
            }
            else { 
                if (change) {
                    localStorage.setItem('AutoRefreshScheduler', 'true'); 
                    document.getElementById('ToggleRefresh').innerHTML = '<i class="fa fa-recycle fa-fw"></i> Auto Refresh On'; 
                    location.reload();
                }
                else {
                    document.getElementById('ToggleRefresh').innerHTML = '<i class="fa fa-recycle fa-fw"></i> Auto Refresh Off';
                }
            }
        }

        // Set a timeout to reload the page every 10 seconds
        setTimeout(reloadPage, 10000); 

    </script>
    </body>
</html>


